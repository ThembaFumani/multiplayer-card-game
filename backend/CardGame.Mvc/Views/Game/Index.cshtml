@model CardGame.Mvc.Models.Game
@{
    ViewData["Title"] = "Card Game";
    var showTieBanner = Model?.Players != null && Model.Players.Count(p => p.Score?.IsWinner == true) > 1;
    var players = Model?.Players?.OrderBy(p => p.Id).ToList() ?? new List<CardGame.Mvc.Models.Player>();
    var positions = new[]
    {
        new { X = 120, Y = 70, Label = "Player 1" },
        new { X = 720, Y = 70, Label = "Player 2" },
        new { X = 820, Y = 255, Label = "Player 3" },
        new { X = 720, Y = 420, Label = "Player 4" },
        new { X = 120, Y = 420, Label = "Player 5" },
        new { X = 40, Y = 255, Label = "Player 6" }
    };
}

@if (TempData["Error"] != null)
{
    <div class="toast-error">
        <span>@TempData["Error"]</span>
        <button onclick="this.parentElement.remove()">×</button>
    </div>
}

@if (Model != null)
{
    <div class="game-container">
        <div class="game-header">
            <h1>Multiplayer Card Game — Poker Table View</h1>
            <div class="controls">
                <form asp-controller="Game" asp-action="Create" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-new-game">New Game</button>
                </form>
                <form asp-controller="Game" asp-action="Redeal" method="post" asp-route-id="@Model.Id" style="display: inline;">
                    <button type="submit" class="btn btn-redeal">Redeal</button>
                </form>
                <a asp-controller="History" asp-action="Index" class="btn btn-history">View History</a>
            </div>
        </div>

        @if (showTieBanner)
        {
            <div class="tie-banner">
                <span>Tie detected — applying suit-product tie-breaker.</span>
            </div>
        }

        <div class="table-container">
            <svg width="1000" height="620" viewBox="0 0 1000 620" xmlns="http://www.w3.org/2000/svg">
                <rect x="20" y="20" width="960" height="580" rx="12" fill="#eef2ff" />

                <g transform="translate(100,110)">
                    <ellipse cx="400" cy="200" rx="360" ry="160" fill="#0f172a" opacity="0.95"/>
                    <ellipse cx="400" cy="200" rx="320" ry="120" fill="#065f46" opacity="0.9"/>
                    <ellipse cx="400" cy="200" rx="260" ry="80" fill="#047857" opacity="0.85"/>
                    <text x="400" y="205" text-anchor="middle" font-size="14" fill="#e6fffa" font-weight="600">
                        @Model.Name — @Model.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                    </text>
                </g>

                @for (int i = 0; i < Math.Min(6, players.Count); i++)
                {
                    var player = players[i];
                    var pos = positions[i];
                    var isWinner = player.Score?.IsWinner ?? false;
                    var strokeColor = isWinner ? "#f59e0b" : "#e6e9ef";
                    var strokeWidth = isWinner ? "3" : "1";

                    <g transform="translate(@pos.X,@pos.Y)">
                        <rect x="0" y="0" width="170" height="110" rx="10" fill="#ffffff" stroke="@strokeColor" stroke-width="@strokeWidth"/>
                        <text x="12" y="18" font-size="12" fill="#0f172a" font-weight="600">@player.Name</text>

                        <g transform="translate(12,28)">
                            @if (player.Cards != null)
                            {
                                @for (int j = 0; j < Math.Min(5, player.Cards.Count); j++)
                                {
                                    var card = player.Cards[j];
                                    var cardX = j * 26;
                                    var suitColor = card.Suit == "♥" || card.Suit == "♦" ? "#dc2626" : "#0f172a";
                                    <g transform="translate(@cardX,0)">
                                        <rect x="0" y="0" width="36" height="52" rx="6" fill="#fff" stroke="#cbd5e1"/>
                                        <text x="18" y="30" text-anchor="middle" font-size="10" fill="#0f172a" font-weight="600">@card.Rank</text>
                                        <text x="18" y="42" text-anchor="middle" font-size="12" fill="@suitColor">@card.Suit</text>
                                    </g>
                                }
                            }
                        </g>

                        <text x="12" y="98" font-size="11" fill="#475569">
                            Hand: <tspan font-weight="700">@(player.Score?.HandSum ?? 0)</tspan>
                        </text>
                        <text x="88" y="98" font-size="11" fill="#94a3b8">
                            Suit: <tspan font-weight="700">@(player.Score?.SuitProduct ?? 0)</tspan>
                        </text>

                        @if (isWinner)
                        {
                            <g transform="translate(124,8)">
                                <circle cx="12" cy="12" r="12" fill="#f59e0b"/>
                                <text x="12" y="16" text-anchor="middle" font-size="12" font-weight="700" fill="#fff">★</text>
                            </g>
                        }
                    </g>
                }
            </svg>
        </div>

        <div class="legend">
            <p><strong>Legend:</strong></p>
            <p>• Hand = sum of card values</p>
            <p>• Suit = product of suit values (♦=1 ♥=2 ♠=3 ♣=4)</p>
            <p>• Gold border + star = winner</p>
        </div>
    </div>
}
else
{
    <div class="error-container">
        <p>Game not found or failed to load.</p>
        <form asp-controller="Game" asp-action="Create" method="post">
            <button type="submit" class="btn btn-primary">Create New Game</button>
        </form>
    </div>
}

@section Styles {
    <link rel="stylesheet" href="~/css/game.css" />
}

